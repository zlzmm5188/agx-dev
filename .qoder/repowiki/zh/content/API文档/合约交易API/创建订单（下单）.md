# 创建订单（下单）

<cite>
**本文档引用的文件**   
- [contract.controller.ts](file://agx-backend/src/modules/contract/contract.controller.ts)
- [contract.dto.ts](file://agx-backend/src/modules/contract/contract.dto.ts)
- [contract.service.ts](file://agx-backend/src/modules/contract/contract.service.ts)
- [contract-order.entity.ts](file://agx-backend/src/entities/contract-order.entity.ts)
- [jwt-auth.guard.ts](file://agx-backend/src/modules/auth/jwt-auth.guard.ts)
- [api-response.dto.ts](file://agx-backend/src/common/dto/api-response.dto.ts)
- [API_CONTRACT.md](file://agx-backend/API_CONTRACT.md)
- [api.js](file://h5/src/utils/api.js)
</cite>

## 目录
1. [接口概述](#接口概述)
2. [认证要求](#认证要求)
3. [请求信息](#请求信息)
4. [数据验证规则](#数据验证规则)
5. [成功响应](#成功响应)
6. [业务逻辑](#业务逻辑)
7. [错误码](#错误码)
8. [使用示例](#使用示例)

## 接口概述

`/api/contract/order` 端点用于创建新的合约订单。该接口接受包含合约配置ID、下单金额和交易方向的请求体，验证用户信息和余额后创建订单，并返回订单详情。

该接口是秒合约交易系统的核心功能之一，允许用户根据预设的合约配置进行看涨或看跌交易。

**Section sources**
- [contract.controller.ts](file://agx-backend/src/modules/contract/contract.controller.ts#L22-L29)

## 认证要求

该接口需要 JWT 认证，通过 `JwtAuthGuard` 守卫实现。客户端必须在请求头中提供有效的 JWT 令牌。

```http
Authorization: Bearer <token>
```

认证守卫会验证令牌的有效性，并从令牌中提取用户信息（主要是用户ID），用于后续的业务逻辑处理。

**Section sources**
- [contract.controller.ts](file://agx-backend/src/modules/contract/contract.controller.ts#L22)
- [jwt-auth.guard.ts](file://agx-backend/src/modules/auth/jwt-auth.guard.ts#L5-L17)

## 请求信息

### 基本信息
- **HTTP 方法**: POST
- **端点**: `/api/contract/order`
- **认证**: 必需 (JWT)

### 请求体格式
请求体应为 JSON 格式，包含以下三个必填字段：

| 字段 | 类型 | 必填 | 说明 |
|------|------|------|------|
| configId | number | 是 | 合约配置ID，正整数 |
| amount | number | 是 | 下单金额，正数 |
| direction | number | 是 | 交易方向：1（看涨）或 2（看跌） |

**Section sources**
- [contract.dto.ts](file://agx-backend/src/modules/contract/contract.dto.ts#L3-L14)
- [API_CONTRACT.md](file://agx-backend/API_CONTRACT.md#L1-L461)

## 数据验证规则

请求体中的数据会通过 `class-validator` 库进行严格验证：

- **configId**: 使用 `@IsNumber()` 和 `@IsPositive()` 装饰器，确保为正整数
- **amount**: 使用 `@IsNumber()` 和 `@IsPositive()` 装饰器，确保为正数
- **direction**: 使用 `@IsNumber()` 和 `@IsIn([1, 2])` 装饰器，确保值为 1 或 2

如果数据验证失败，系统将返回参数错误（错误码 1001）。

```mermaid
flowchart TD
Start([开始创建订单]) --> ValidateInput["验证输入参数"]
ValidateInput --> ConfigIdValid{"configId 为正整数?"}
ConfigIdValid --> |否| ReturnError1["返回错误: 参数错误"]
ConfigIdValid --> |是| AmountValid{"amount 为正数?"}
AmountValid --> |否| ReturnError2["返回错误: 参数错误"]
AmountValid --> |是| DirectionValid{"direction 为1或2?"}
DirectionValid --> |否| ReturnError3["返回错误: 参数错误"]
DirectionValid --> |是| Continue["继续业务逻辑"]
```

**Diagram sources **
- [contract.dto.ts](file://agx-backend/src/modules/contract/contract.dto.ts#L3-L14)

**Section sources**
- [contract.dto.ts](file://agx-backend/src/modules/contract/contract.dto.ts#L3-L14)

## 成功响应

当订单创建成功时，接口返回包含订单详情的 JSON 对象：

```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "orderId": 123,
    "orderNo": "C20240115103000123456",
    "symbol": "XAU/USD",
    "direction": 1,
    "directionText": "看涨",
    "amount": "100.00",
    "openPrice": "2050.50",
    "duration": 60,
    "profitRate": "0.95",
    "openAt": "2024-01-15 10:30:00",
    "closeAt": "2024-01-15 10:31:00"
  }
}
```

| 字段 | 类型 | 说明 |
|------|------|------|
| orderId | number | 订单ID |
| orderNo | string | 订单号 |
| symbol | string | 交易对符号 |
| direction | number | 方向：1（看涨）或 2（看跌） |
| directionText | string | 方向文本描述 |
| amount | string | 下单金额 |
| openPrice | string | 开仓价格 |
| duration | number | 周期（秒） |
| profitRate | string | 收益率 |
| openAt | string | 开仓时间 |
| closeAt | string | 平仓时间 |

**Section sources**
- [contract.service.ts](file://agx-backend/src/modules/contract/contract.service.ts#L140-L152)
- [API_CONTRACT.md](file://agx-backend/API_CONTRACT.md#L1-L461)

## 业务逻辑

创建订单的业务逻辑包含多个步骤，确保交易的安全性和准确性：

1. **验证合约配置**: 根据 `configId` 查询合约配置，确保配置存在且状态为启用
2. **金额范围检查**: 验证下单金额是否在配置规定的最小和最大金额范围内
3. **余额检查**: 检查用户 AGX 币种的余额是否足够支付下单金额
4. **事务处理**: 使用数据库事务确保余额扣减和订单创建的原子性
5. **订单创建**: 创建订单记录，生成唯一订单号，设置初始状态
6. **定时结算**: 设置定时器，在合约周期结束后自动结算订单

```mermaid
sequenceDiagram
participant Client as "客户端"
participant Controller as "ContractController"
participant Service as "ContractService"
participant DB as "数据库"
Client->>Controller : POST /api/contract/order
Controller->>Service : createOrder(userId, dto)
Service->>DB : 查询合约配置
DB-->>Service : 返回配置
Service->>Service : 验证金额范围
Service->>DB : 查询用户钱包
DB-->>Service : 返回钱包信息
Service->>Service : 检查余额
Service->>Service : 开始事务
Service->>DB : 扣减用户余额
Service->>DB : 创建订单记录
Service->>Service : 提交事务
Service->>Service : 设置定时结算
Service-->>Controller : 返回订单详情
Controller-->>Client : 返回成功响应
```

**Diagram sources **
- [contract.service.ts](file://agx-backend/src/modules/contract/contract.service.ts#L68-L158)

**Section sources**
- [contract.service.ts](file://agx-backend/src/modules/contract/contract.service.ts#L68-L158)

## 错误码

| 错误码 | 说明 | 触发条件 |
|--------|------|----------|
| 0 | 成功 | 订单创建成功 |
| 1001 | 参数错误 | 输入参数验证失败 |
| 1002 | 未登录 | JWT 令牌缺失或无效 |
| 4001 | 合约配置不存在 | configId 对应的合约配置不存在或已禁用 |
| 4002 | 最小下单金额 | 下单金额小于合约配置的最小金额 |
| 4003 | 最大下单金额 | 下单金额大于合约配置的最大金额 |
| 4004 | AGX币种未配置 | 系统中未找到 AGX 币种配置 |
| 4005 | AGX余额不足 | 用户 AGX 余额不足以支付下单金额 |

**Section sources**
- [api-response.dto.ts](file://agx-backend/src/common/dto/api-response.dto.ts#L27-L67)
- [contract.service.ts](file://agx-backend/src/modules/contract/contract.service.ts#L73-L100)

## 使用示例

### curl 请求示例

```bash
curl -X POST https://api.yourdomain.com/api/contract/order \
  -H "Authorization: Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." \
  -H "Content-Type: application/json" \
  -d '{
    "configId": 1,
    "amount": 100,
    "direction": 1
  }'
```

### 成功响应示例

```json
{
  "code": 0,
  "msg": "ok",
  "data": {
    "orderId": 12345,
    "orderNo": "C20240115103000123456",
    "symbol": "XAU/USD",
    "direction": 1,
    "directionText": "看涨",
    "amount": "100.00",
    "openPrice": "2050.50",
    "duration": 60,
    "profitRate": "0.95",
    "openAt": "2024-01-15 10:30:00",
    "closeAt": "2024-01-15 10:31:00"
  }
}
```

### 前端调用示例

```javascript
// 在 h5 项目中
api.contract.createOrder({
  configId: 1,
  amount: 100,
  direction: 1
}).then(response => {
  console.log('订单创建成功:', response.data);
}).catch(error => {
  console.error('下单失败:', error.response.data.msg);
});
```

**Section sources**
- [api.js](file://h5/src/utils/api.js#L128-L130)
- [API_CONTRACT.md](file://agx-backend/API_CONTRACT.md#L1-L461)