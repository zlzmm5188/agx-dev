# 注册管理

<cite>
**本文档引用的文件**  
- [account.controller.ts](file://agx-backend/src/modules/account/account.controller.ts)
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [business.exception.ts](file://agx-backend/src/common/filters/business.exception.ts)
- [api-response.dto.ts](file://agx-backend/src/common/dto/api-response.dto.ts)
- [ma-verifyCode/index.vue](file://agx-admin/src/components/ma-verifyCode/index.vue)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心组件](#核心组件)
3. [注册数据验证规则](#注册数据验证规则)
4. [密码加密存储流程](#密码加密存储流程)
5. [用户创建异常处理](#用户创建异常处理)
6. [注册流程时序图](#注册流程时序图)
7. [前端表单验证示例](#前端表单验证示例)
8. [验证码集成方案](#验证码集成方案)
9. [用户数据隐私保护](#用户数据隐私保护)

## 项目结构

```mermaid
graph TD
A[agx-dev] --> B[agx-backend]
A --> C[agx-admin]
A --> D[h5]
B --> E[src/modules/account]
E --> F[account.controller.ts]
E --> G[account.dto.ts]
E --> H[account.service.ts]
B --> I[src/entities]
I --> J[user.entity.ts]
B --> K[src/common]
K --> L[filters/business.exception.ts]
K --> M[dto/api-response.dto.ts]
C --> N[src/components]
N --> O[ma-verifyCode/index.vue]
C --> P[src/views]
P --> Q[login.vue]
P --> R[userCenter/index.vue]
P --> S[system/user/index.vue]
```

**Diagram sources**
- [account.controller.ts](file://agx-backend/src/modules/account/account.controller.ts)
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [business.exception.ts](file://agx-backend/src/common/filters/business.exception.ts)
- [api-response.dto.ts](file://agx-backend/src/common/dto/api-response.dto.ts)
- [ma-verifyCode/index.vue](file://agx-admin/src/components/ma-verifyCode/index.vue)

**Section sources**
- [account.controller.ts](file://agx-backend/src/modules/account/account.controller.ts)
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [business.exception.ts](file://agx-backend/src/common/filters/business.exception.ts)
- [api-response.dto.ts](file://agx-backend/src/common/dto/api-response.dto.ts)
- [ma-verifyCode/index.vue](file://agx-admin/src/components/ma-verifyCode/index.vue)

## 核心组件

账户注册功能的核心组件包括控制器、数据传输对象、服务类和实体类。控制器负责处理HTTP请求，数据传输对象定义请求参数结构，服务类实现业务逻辑，实体类映射数据库表结构。

**Section sources**
- [account.controller.ts](file://agx-backend/src/modules/account/account.controller.ts)
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)

## 注册数据验证规则

注册功能通过`RegisterDto`类定义数据验证规则，确保用户输入符合系统要求。验证规则包括用户名、密码和邀请码的格式要求。

```mermaid
flowchart TD
Start([开始注册]) --> ValidateUsername["验证用户名"]
ValidateUsername --> UsernameValid{"用户名有效?"}
UsernameValid --> |否| ReturnUsernameError["返回用户名错误"]
UsernameValid --> |是| ValidatePassword["验证密码"]
ValidatePassword --> PasswordValid{"密码有效?"}
PasswordValid --> |否| ReturnPasswordError["返回密码错误"]
PasswordValid --> |是| ValidateInviteCode["验证邀请码"]
ValidateInviteCode --> InviteCodeValid{"邀请码有效?"}
InviteCodeValid --> |否| ReturnInviteCodeError["返回邀请码错误"]
InviteCodeValid --> |是| ProceedToRegistration["继续注册流程"]
ReturnUsernameError --> End([结束])
ReturnPasswordError --> End
ReturnInviteCodeError --> End
ProceedToRegistration --> End
```

**Diagram sources**
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts#L3-L16)

**Section sources**
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts#L3-L16)

## 密码加密存储流程

系统使用bcrypt哈希算法对用户密码进行加密存储，确保密码安全。bcrypt是一种自适应哈希函数，具有盐值生成和计算成本控制特性。

```mermaid
sequenceDiagram
participant Frontend as 前端
participant Controller as AccountController
participant Service as AccountService
participant Bcrypt as bcrypt
participant Database as 数据库
Frontend->>Controller : POST /api/account/register
Controller->>Service : 调用register方法
Service->>Service : 检查用户名是否存在
Service->>Service : 检查邀请码是否有效
Service->>Bcrypt : 生成密码哈希(bcrypt.hash)
Bcrypt-->>Service : 返回哈希值
Service->>Service : 生成UID和邀请码
Service->>Database : 保存用户信息
Database-->>Service : 保存成功
Service-->>Controller : 返回注册结果
Controller-->>Frontend : 返回成功响应
```

**Diagram sources**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L94-L108)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L24)

**Section sources**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L94-L108)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L24)

## 用户创建异常处理

系统在用户创建过程中实现了完善的异常处理机制，能够识别和处理各种异常情况，如用户名重复、邀请码无效等。

```mermaid
flowchart TD
Start([用户注册]) --> CheckUsername["检查用户名是否存在"]
CheckUsername --> UsernameExists{"用户名已存在?"}
UsernameExists --> |是| ThrowUserExists["抛出用户已存在异常"]
UsernameExists --> |否| CheckInviteCode["检查邀请码有效性"]
CheckInviteCode --> InviteCodeValid{"邀请码有效?"}
InviteCodeValid --> |否| ThrowInviteCodeInvalid["抛出邀请码无效异常"]
InviteCodeValid --> |是| GenerateUID["生成UID"]
GenerateUID --> CheckUIDUnique{"UID唯一?"}
CheckUIDUnique --> |否| RegenerateUID["重新生成UID"]
CheckUIDUnique --> |是| GenerateInviteCode["生成邀请码"]
GenerateInviteCode --> CheckInviteCodeUnique{"邀请码唯一?"}
CheckInviteCodeUnique --> |否| RegenerateInviteCode["重新生成邀请码"]
CheckInviteCodeUnique --> |是| HashPassword["哈希密码"]
HashPassword --> SaveUser["保存用户"]
SaveUser --> CreateUserRelations["创建用户关系"]
CreateUserRelations --> CreateWallets["创建钱包"]
CreateWallets --> ReturnSuccess["返回成功"]
RegenerateUID --> CheckUIDUnique
RegenerateInviteCode --> CheckInviteCodeUnique
ThrowUserExists --> End([返回错误])
ThrowInviteCodeInvalid --> End
ReturnSuccess --> End
```

**Diagram sources**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L65-L93)
- [business.exception.ts](file://agx-backend/src/common/filters/business.exception.ts#L36-L42)

**Section sources**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L65-L93)
- [business.exception.ts](file://agx-backend/src/common/filters/business.exception.ts#L36-L42)

## 注册流程时序图

完整的注册流程时序图展示了从前端请求到后端处理再到数据库存储的完整流程。

```mermaid
sequenceDiagram
participant Client as 客户端
participant API as API网关
participant Controller as AccountController
participant Service as AccountService
participant Repository as UserRepository
participant Database as 数据库
Client->>API : 发送注册请求
API->>Controller : 转发请求
Controller->>Service : 调用register(dto)
Service->>Repository : findOne(用户名)
Repository-->>Service : 返回查询结果
Service->>Repository : findOne(邀请码)
Repository-->>Service : 返回邀请人信息
Service->>Bcrypt : hash(密码, 10)
Bcrypt-->>Service : 返回哈希值
Service->>Repository : create(用户对象)
Service->>Repository : save(用户)
Repository-->>Database : 插入用户记录
Database-->>Repository : 返回插入结果
Repository-->>Service : 返回保存结果
Service->>Repository : create(邀请关系)
Service->>Repository : save(邀请关系)
Service->>Repository : create(钱包)
Service->>Repository : save(钱包)
Service-->>Controller : 返回注册结果
Controller-->>API : 返回响应
API-->>Client : 返回成功/失败
```

**Diagram sources**
- [account.controller.ts](file://agx-backend/src/modules/account/account.controller.ts#L16-L19)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L65-L151)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)

**Section sources**
- [account.controller.ts](file://agx-backend/src/modules/account/account.controller.ts#L16-L19)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L65-L151)

## 前端表单验证示例

为初学者提供的前端表单验证示例代码，展示了如何在前端实现基本的表单验证。

```mermaid
flowchart TD
A[注册表单] --> B[用户名输入]
B --> C[4-20位字符]
C --> D[仅字母、数字、下划线]
D --> E[密码输入]
E --> F[8-20位字符]
F --> G[邀请码输入]
G --> H[6位大写字母数字]
H --> I[提交按钮]
I --> J[前端验证]
J --> K{验证通过?}
K --> |否| L[显示错误信息]
K --> |是| M[发送API请求]
L --> J
M --> N[等待响应]
N --> O{成功?}
O --> |否| P[显示错误]
O --> |是| Q[跳转到登录页]
```

**Diagram sources**
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts#L3-L16)

**Section sources**
- [account.dto.ts](file://agx-backend/src/modules/account/account.dto.ts#L3-L16)

## 验证码集成方案

为高级开发者提供的验证码集成方案，用于防止机器人注册。

```mermaid
classDiagram
class VerifyCodeComponent {
+width : number
+height : number
+pool : string
+size : number
+showError : boolean
+codeText : string
-randomNum(min, max) : number
-randomColor(min, max) : string
+generateCode() : void
+checkResult(verifyCode) : boolean
+refresh() : void
}
class RegisterForm {
-verifyCodeRef : Ref
+onSubmit() : Promise
-validateForm() : boolean
}
RegisterForm --> VerifyCodeComponent : 使用
VerifyCodeComponent : Canvas元素
VerifyCodeComponent : 随机字符生成
VerifyCodeComponent : 干扰线和点
```

**Diagram sources**
- [ma-verifyCode/index.vue](file://agx-admin/src/components/ma-verifyCode/index.vue)

**Section sources**
- [ma-verifyCode/index.vue](file://agx-admin/src/components/ma-verifyCode/index.vue)

## 用户数据隐私保护

系统实施了多项用户数据隐私保护措施，确保用户信息安全。

```mermaid
flowchart TD
A[用户数据] --> B[传输层]
B --> C[HTTPS加密]
C --> D[存储层]
D --> E[密码哈希(bcrypt)]
E --> F[数据库]
F --> G[敏感数据脱敏]
G --> H[日志记录]
H --> I[IP地址匿名化]
I --> J[访问控制]
J --> K[JWT认证]
K --> L[权限验证]
L --> M[审计日志]
subgraph "安全措施"
C
E
G
I
K
M
end
```

**Diagram sources**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L94)
- [jwt.strategy.ts](file://agx-backend/src/modules/auth/jwt.strategy.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L316)

**Section sources**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L94)
- [jwt.strategy.ts](file://agx-backend/src/modules/auth/jwt.strategy.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L316)