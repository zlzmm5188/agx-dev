# 资产模型

<cite>
**本文档引用的文件**
- [asset.entity.ts](file://agx-backend/src/entities/asset.entity.ts)
- [coin.entity.ts](file://agx-backend/src/entities/coin.entity.ts)
- [coin-chain.entity.ts](file://agx-backend/src/entities/coin-chain.entity.ts)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)
- [asset-log.entity.ts](file://agx-backend/src/entities/asset-log.entity.ts)
- [asset-ticker.entity.ts](file://agx-backend/src/entities/asset-ticker.entity.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [recharge.entity.ts](file://agx-backend/src/entities/recharge.entity.ts)
- [withdraw.entity.ts](file://agx-backend/src/entities/withdraw.entity.ts)
</cite>

## 目录
1. [项目结构](#项目结构)
2. [核心资产实体](#核心资产实体)
3. [相关实体与关系](#相关实体与关系)
4. [资产变动审计追踪](#资产变动审计追踪)
5. [余额一致性保证](#余额一致性保证)
6. [多链资产支持](#多链资产支持)
7. [资产查询性能优化](#资产查询性能优化)
8. [安全审计要求](#安全审计要求)

## 项目结构

系统采用分层架构，前端位于`agx-admin`目录，后端服务位于`agx-backend`目录。资产相关的核心逻辑集中在后端的实体层和账户服务模块中。

```mermaid
graph TB
subgraph "前端"
A[agx-admin]
end
subgraph "后端"
B[agx-backend]
C[entities]
D[modules/account]
end
A --> B
B --> C
B --> D
```

**图示来源**
- [asset.entity.ts](file://agx-backend/src/entities/asset.entity.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)

**本节来源**
- [agx-backend/src/entities](file://agx-backend/src/entities)
- [agx-backend/src/modules/account](file://agx-backend/src/modules/account)

## 核心资产实体

`Asset`实体定义了平台支持的各类资产（如加密货币、外汇、股票、贵金属等）的基本信息和配置。该实体不直接存储用户余额，而是作为资产元数据的定义。

```mermaid
classDiagram
class Asset {
+id : bigint
+symbol : string
+name : string
+nameEn : string
+nameZh : string
+assetType : string
+quoteAsset : string
+icon : string
+decimals : number
+dataSource : string
+dataSourceSymbol : string
+isTradable : number
+isContract : number
+isHot : number
+sortOrder : number
+status : number
+extra : string
+createdAt : Date
+updatedAt : Date
}
```

**图示来源**
- [asset.entity.ts](file://agx-backend/src/entities/asset.entity.ts#L1-L80)

**本节来源**
- [asset.entity.ts](file://agx-backend/src/entities/asset.entity.ts#L1-L80)

## 相关实体与关系

资产系统涉及多个核心实体，包括币种(Coin)、用户钱包(Wallet)、资产日志(AssetLog)、行情数据(AssetTicker)等，它们共同构成了完整的资产管理体系。

```mermaid
erDiagram
ASSET ||--o{ COIN : "包含"
COIN ||--o{ COIN_CHAIN : "支持多链"
COIN ||--o{ WALLET : "用户持有"
USER ||--o{ WALLET : "拥有"
USER ||--o{ ASSET_LOG : "产生"
ASSET ||--o{ ASSET_TICKER : "缓存"
ASSET {
bigint id PK
varchar symbol UK
varchar name
varchar asset_type
varchar quote_asset
smallint decimals
smallint is_tradable
smallint status
}
COIN {
bigint id PK
varchar symbol UK
varchar name
smallint decimals
smallint is_deposit
smallint is_withdraw
decimal min_withdraw
decimal withdraw_fee
}
COIN_CHAIN {
bigint id PK
bigint coin_id FK
varchar chain
varchar chain_symbol
varchar contract_address
decimal withdraw_fee
decimal min_withdraw
decimal max_withdraw
}
WALLET {
bigint id PK
bigint user_id FK
bigint coin_id FK
decimal balance
decimal frozen
}
ASSET_LOG {
bigint id PK
bigint user_id FK
varchar coin
varchar type
decimal amount
decimal balance_before
decimal balance_after
varchar ref_no
varchar remark
}
ASSET_TICKER {
bigint id PK
varchar symbol
varchar asset_type
decimal last_price
decimal open_price
decimal high_price
decimal low_price
decimal price_change_percent
decimal volume
decimal quote_volume
}
USER {
bigint id PK
varchar uid UK
varchar username UK
varchar invite_code UK
}
```

**图示来源**
- [asset.entity.ts](file://agx-backend/src/entities/asset.entity.ts)
- [coin.entity.ts](file://agx-backend/src/entities/coin.entity.ts)
- [coin-chain.entity.ts](file://agx-backend/src/entities/coin-chain.entity.ts)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)
- [asset-log.entity.ts](file://agx-backend/src/entities/asset-log.entity.ts)
- [asset-ticker.entity.ts](file://agx-backend/src/entities/asset-ticker.entity.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)

**本节来源**
- [coin.entity.ts](file://agx-backend/src/entities/coin.entity.ts)
- [coin-chain.entity.ts](file://agx-backend/src/entities/coin-chain.entity.ts)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)
- [asset-log.entity.ts](file://agx-backend/src/entities/asset-log.entity.ts)
- [asset-ticker.entity.ts](file://agx-backend/src/entities/asset-ticker.entity.ts)

## 资产变动审计追踪

系统通过`AssetLog`实体记录所有资产变动，确保完整的审计追踪能力。每次资产变动都会生成一条日志，包含变动前后的余额、变动金额、类型和关联单号。

```mermaid
sequenceDiagram
participant 用户
participant AccountService
participant WalletRepo
participant AssetLogRepo
用户->>AccountService : 发起提现请求
AccountService->>WalletRepo : 查询钱包余额
WalletRepo-->>AccountService : 返回余额
AccountService->>WalletRepo : 冻结相应金额
WalletRepo-->>AccountService : 更新成功
AccountService->>AssetLogRepo : 创建资产变动日志
AssetLogRepo-->>AccountService : 日志创建成功
AccountService-->>用户 : 返回提现成功响应
```

**图示来源**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L433-L483)
- [asset-log.entity.ts](file://agx-backend/src/entities/asset-log.entity.ts)

**本节来源**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L433-L483)
- [asset-log.entity.ts](file://agx-backend/src/entities/asset-log.entity.ts)

## 余额一致性保证

系统通过事务性操作和双重校验机制保证余额一致性。在资产变动时，先检查余额是否充足，然后更新钱包余额并创建审计日志。

```mermaid
flowchart TD
Start([开始提现])
--> CheckKYC["检查KYC认证状态"]
--> CheckKYCValid{"KYC已认证?"}
--> |否| ReturnError1["返回错误：请先完成实名认证"]
--> End
CheckKYCValid --> |是| QueryBalance["查询钱包余额"]
--> CompareBalance{"余额充足?"}
--> |否| ReturnError2["返回错误：余额不足"]
--> End
CompareBalance --> |是| FreezeBalance["冻结相应金额"]
--> CreateWithdraw["创建提现记录"]
--> CreateAssetLog["创建资产变动日志"]
--> ReturnSuccess["返回成功响应"]
--> End([结束])
```

**图示来源**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L433-L483)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)

**本节来源**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L433-L483)

## 多链资产支持

系统通过`CoinChain`实体支持同一币种在不同区块链网络上的提现和充值。每个币种可以配置多条链，每条链有独立的手续费、最小提现额等参数。

```mermaid
classDiagram
class Coin {
+id : bigint
+symbol : string
+name : string
+decimals : number
+isDeposit : number
+isWithdraw : number
+minWithdraw : string
+withdrawFee : string
}
class CoinChain {
+id : bigint
+coinId : number
+chain : string
+chainSymbol : string
+contractAddress : string
+withdrawFee : string
+minWithdraw : string
+maxWithdraw : string
+confirmations : number
+status : number
}
Coin ||--o{ CoinChain : "支持多链"
```

**图示来源**
- [coin.entity.ts](file://agx-backend/src/entities/coin.entity.ts)
- [coin-chain.entity.ts](file://agx-backend/src/entities/coin-chain.entity.ts)

**本节来源**
- [coin-chain.entity.ts](file://agx-backend/src/entities/coin-chain.entity.ts)

## 资产查询性能优化

系统通过索引设计和缓存机制优化资产查询性能。关键字段如用户ID、币种符号等都建立了数据库索引，同时行情数据通过`AssetTicker`表进行缓存。

```mermaid
graph TD
A[资产查询请求]
--> B{查询类型}
--> |用户余额| C["查询Wallet表<br/>使用idx_user_id索引"]
--> D[返回结果]
B --> |资产列表| E["查询Asset表<br/>使用idx_asset_type索引"]
--> F[返回结果]
B --> |行情数据| G["查询AssetTicker表<br/>使用idx_symbol索引"]
--> H[返回结果]
B --> |交易记录| I["查询Recharge/Withdraw表<br/>使用created_at索引"]
--> J[返回结果]
```

**图示来源**
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)
- [asset.entity.ts](file://agx-backend/src/entities/asset.entity.ts)
- [asset-ticker.entity.ts](file://agx-backend/src/entities/asset-ticker.entity.ts)
- [recharge.entity.ts](file://agx-backend/src/entities/recharge.entity.ts)
- [withdraw.entity.ts](file://agx-backend/src/entities/withdraw.entity.ts)

**本节来源**
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)
- [asset-ticker.entity.ts](file://agx-backend/src/entities/asset-ticker.entity.ts)

## 安全审计要求

系统实现了严格的安全审计机制，所有敏感操作都需要身份验证和KYC认证。资产变动操作都会记录详细日志，便于追踪和审计。

```mermaid
flowchart TD
A[用户操作]
--> B{操作类型}
--> |登录| C["记录登录日志<br/>包含IP和时间"]
B --> |密码修改| D["验证原密码<br/>记录操作日志"]
B --> |资产变动| E["检查KYC状态<br/>验证余额充足"]
--> F["执行余额更新<br/>创建资产日志"]
B --> |提现| G["验证KYC认证<br/>检查提现限额"]
--> H["冻结余额<br/>创建提现记录"]
C --> I[安全审计完成]
D --> I
F --> I
H --> I
```

**图示来源**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)

**本节来源**
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)