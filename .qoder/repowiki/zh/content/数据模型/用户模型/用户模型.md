# 用户模型

<cite>
**本文档中引用的文件**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)
- [user-level.entity.ts](file://agx-backend/src/entities/user-level.entity.ts)
- [user-invite.entity.ts](file://agx-backend/src/entities/user-invite.entity.ts)
- [invite-reward.entity.ts](file://agx-backend/src/entities/invite-reward.entity.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [invite.service.ts](file://agx-backend/src/modules/invite/invite.service.ts)
</cite>

## 目录
1. [简介](#简介)
2. [项目结构](#项目结构)
3. [核心组件](#核心组件)
4. [架构概述](#架构概述)
5. [详细组件分析](#详细组件分析)
6. [依赖分析](#依赖分析)
7. [性能考虑](#性能考虑)
8. [故障排除指南](#故障排除指南)
9. [结论](#结论)

## 简介
本文档全面描述了用户数据模型，重点关注User实体及其相关实体（如KYC、Wallet、UserLevel、UserInvite等）。文档详细说明了用户实体的字段定义、数据类型、索引和约束条件，以及与其他实体的关联关系。同时涵盖用户数据生命周期管理、KYC信息的安全存储策略、邀请奖励机制的数据结构，并提供TypeORM关系映射代码示例和开发者最佳实践。

## 项目结构
用户数据模型主要位于`agx-backend/src/entities/`目录下，相关业务逻辑在`agx-backend/src/modules/`中实现。前端管理界面位于`agx-admin/src/views/agx/`路径下。

```mermaid
graph TB
subgraph "后端实体"
User[用户实体 user.entity.ts]
KYC[KYC实体 kyc.entity.ts]
Wallet[钱包实体 wallet.entity.ts]
UserLevel[用户等级 user-level.entity.ts]
UserInvite[邀请关系 user-invite.entity.ts]
InviteReward[邀请奖励 invite-reward.entity.ts]
end
subgraph "后端服务"
AccountService[账户服务 account.service.ts]
InviteService[邀请服务 invite.service.ts]
end
subgraph "前端管理"
UsersView[用户管理 users.vue]
KYCView[kyc.vue]
InviteView[invites.vue]
end
User --> KYC
User --> Wallet
User --> UserLevel
User --> UserInvite
User --> InviteReward
AccountService --> User
InviteService --> UserInvite
UsersView --> AccountService
KYCView --> KYC
InviteView --> InviteService
```

**图示来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)
- [user-level.entity.ts](file://agx-backend/src/entities/user-level.entity.ts)
- [user-invite.entity.ts](file://agx-backend/src/entities/user-invite.entity.ts)
- [invite-reward.entity.ts](file://agx-backend/src/entities/invite-reward.entity.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [invite.service.ts](file://agx-backend/src/modules/invite/invite.service.ts)

**本节来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts)

## 核心组件
核心用户数据模型由User实体及其相关实体构成，实现了用户信息管理、身份认证、钱包系统、等级体系和邀请奖励机制的完整闭环。

**本节来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L12-L117)
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts#L13-L56)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts#L15-L41)

## 架构概述
用户数据模型采用分层架构设计，以User实体为核心，通过TypeORM关系映射连接各个相关实体，形成完整的用户数据生态系统。

```mermaid
erDiagram
USER {
bigint id PK
varchar uid UK
varchar username UK
varchar password_hash
varchar nickname
varchar avatar
varchar invite_code UK
bigint inviter_id FK
smallint kyc_status
smallint status
int level
int invite_count
int team_count
decimal total_commission
decimal total_trade_volume
timestamp created_at
timestamp updated_at
timestamp deleted_at
}
KYC {
bigint id PK
bigint user_id FK
varchar real_name
varchar id_number
smallint id_type
varchar front_image
varchar back_image
varchar hold_image
smallint status
timestamp created_at
timestamp updated_at
}
WALLET {
bigint id PK
bigint user_id FK
bigint coin_id FK
decimal balance
decimal frozen
timestamp created_at
timestamp updated_at
}
USER_LEVEL {
bigint id PK
int level UK
varchar name
varchar name_en
varchar icon
varchar color
decimal min_assets
int min_invites
decimal min_trade_volume
decimal commission_rate_1
decimal commission_rate_2
decimal fee_discount
timestamp created_at
timestamp updated_at
}
USER_INVITE {
bigint id PK
bigint user_id FK
bigint inviter_id FK
smallint level
timestamp created_at
}
INVITE_REWARD {
bigint id PK
bigint user_id FK
bigint invited_user_id FK
varchar reward_type
decimal amount
varchar coin_symbol
smallint status
timestamp created_at
}
USER ||--|| KYC : "一对一"
USER ||--o{ WALLET : "一对多"
USER ||--|| USER_LEVEL : "多对一"
USER ||--o{ USER_INVITE : "一对多(被邀请)"
USER ||--o{ USER_INVITE : "一对多(邀请人)"
USER ||--o{ INVITE_REWARD : "一对多(获得奖励)"
USER ||--o{ INVITE_REWARD : "一对多(被邀请人)"
```

**图示来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L12-L117)
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts#L13-L56)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts#L15-L41)
- [user-level.entity.ts](file://agx-backend/src/entities/user-level.entity.ts#L14-L66)
- [user-invite.entity.ts](file://agx-backend/src/entities/user-invite.entity.ts#L13-L38)
- [invite-reward.entity.ts](file://agx-backend/src/entities/invite-reward.entity.ts#L13-L42)

## 详细组件分析

### 用户实体分析
User实体是整个用户数据模型的核心，包含用户基本信息、状态控制、等级信息和社交属性。

```mermaid
classDiagram
class User {
+id : number
+uid : string
+username : string
+passwordHash : string
+nickname : string
+avatar : string
+inviteCode : string
+inviterId : number
+kycStatus : number
+status : number
+level : number
+isVerified : number
+userTag : string
+inviteCount : number
+teamCount : number
+totalCommission : string
+totalTradeVolume : string
+followerCount : number
+followingCount : number
+postCount : number
+bio : string
+socialStatus : number
+canBeFriended : number
+canSendFriendRequest : number
+canChat : number
+friendCount : number
+muteUntil : Date
+lastLoginAt : Date
+lastLoginIp : string
+createdAt : Date
+updatedAt : Date
+deletedAt : Date
}
class Kyc {
+id : number
+userId : number
+realName : string
+idNumber : string
+idType : number
+frontImage : string
+backImage : string
+holdImage : string
+status : number
+remark : string
+reviewedAt : Date
+createdAt : Date
+updatedAt : Date
}
class Wallet {
+id : number
+userId : number
+coinId : number
+balance : string
+frozen : string
+createdAt : Date
+updatedAt : Date
}
class UserLevel {
+id : number
+level : number
+name : string
+nameEn : string
+icon : string
+color : string
+minAssets : string
+minInvites : number
+minTradeVolume : string
+commissionRate1 : string
+commissionRate2 : string
+feeDiscount : string
+benefits : string
+sortOrder : number
+status : number
+createdAt : Date
+updatedAt : Date
}
User "1" -- "1" Kyc : "一对一"
User "1" -- "*" Wallet : "一对多"
User "1" -- "1" UserLevel : "多对一"
```

**图示来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L12-L117)
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts#L13-L56)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts#L15-L41)
- [user-level.entity.ts](file://agx-backend/src/entities/user-level.entity.ts#L14-L66)

### KYC实体分析
KYC实体用于管理用户身份认证信息，与User实体形成一对一关系。

```mermaid
sequenceDiagram
participant Frontend as "前端"
participant AccountService as "AccountService"
participant User as "User Entity"
participant Kyc as "Kyc Entity"
Frontend->>AccountService : 提交KYC认证
AccountService->>User : 查询用户信息
User-->>AccountService : 返回用户数据
AccountService->>Kyc : 创建KYC记录
Kyc-->>AccountService : 返回KYC数据
AccountService->>AccountService : 验证KYC信息
AccountService->>User : 更新kycStatus
User-->>AccountService : 返回更新结果
AccountService-->>Frontend : 返回认证结果
```

**图示来源**  
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts#L13-L56)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)

### 邀请系统分析
邀请系统通过UserInvite和InviteReward实体实现完整的邀请关系追踪和奖励发放机制。

```mermaid
flowchart TD
Start([用户注册]) --> GenerateCode["生成邀请码"]
GenerateCode --> SaveUser["保存用户信息"]
SaveUser --> CheckInvite["检查邀请码"]
CheckInvite --> |有邀请码| FindInviter["查找邀请人"]
FindInviter --> CreateInvite["创建邀请关系"]
CreateInvite --> CalculateLevel["计算邀请层级"]
CalculateLevel --> SaveInvite["保存邀请记录"]
SaveInvite --> CheckReward["检查奖励条件"]
CheckReward --> CreateReward["创建奖励记录"]
CreateReward --> End([完成注册])
CheckInvite --> |无邀请码| End
CreateReward --> End
```

**图示来源**  
- [user-invite.entity.ts](file://agx-backend/src/entities/user-invite.entity.ts#L13-L38)
- [invite-reward.entity.ts](file://agx-backend/src/entities/invite-reward.entity.ts#L13-L42)
- [invite.service.ts](file://agx-backend/src/modules/invite/invite.service.ts)

**本节来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts#L12-L117)
- [kyc.entity.ts](file://agx-backend/src/entities/kyc.entity.ts#L13-L56)
- [wallet.entity.ts](file://agx-backend/src/entities/wallet.entity.ts#L15-L41)
- [user-level.entity.ts](file://agx-backend/src/entities/user-level.entity.ts#L14-L66)
- [user-invite.entity.ts](file://agx-backend/src/entities/user-invite.entity.ts#L13-L38)
- [invite-reward.entity.ts](file://agx-backend/src/entities/invite-reward.entity.ts#L13-L42)

## 依赖分析
用户数据模型的依赖关系清晰，各实体通过外键关联，服务层实现业务逻辑。

```mermaid
graph TD
AccountService --> User
AccountService --> Kyc
AccountService --> Wallet
InviteService --> UserInvite
InviteService --> InviteReward
User --> UserLevel
User --> UserInvite
User --> InviteReward
User --> Kyc
User --> Wallet
```

**图示来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [invite.service.ts](file://agx-backend/src/modules/invite/invite.service.ts)

**本节来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)
- [invite.service.ts](file://agx-backend/src/modules/invite/invite.service.ts)

## 性能考虑
用户数据模型在设计时考虑了性能优化，通过索引、缓存和批量操作提高查询效率。

**本节来源**  
- [user.entity.ts](file://agx-backend/src/entities/user.entity.ts)
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts)

## 故障排除指南
常见问题包括用户注册失败、KYC认证状态不更新、邀请奖励未发放等，主要检查数据库约束、服务逻辑和事务处理。

**本节来源**  
- [account.service.ts](file://agx-backend/src/modules/account/account.service.ts#L1-L200)
- [invite.service.ts](file://agx-backend/src/modules/invite/invite.service.ts#L1-L150)

## 结论
用户数据模型设计完整，通过TypeORM实现了清晰的实体关系映射，支持用户管理、身份认证、钱包系统和邀请奖励等核心功能。建议在查询时充分利用索引，在事务处理时注意数据一致性。